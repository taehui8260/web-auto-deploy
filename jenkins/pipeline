node {

    def MAVEN_HOME
    def JAVA_HOME
    def CURRENT_DATE

    stage('Preparation') {
        MAVEN_HOME = tool 'MAVEN_3.9.4'
        JAVA_HOME = tool name: 'OpenJDK11', type: 'hudson.model.JDK'
        env.JAVA_HOME = "${JAVA_HOME}"
        env.PATH = "${env.PATH}:${env.JAVA_HOME}/bin"
        CURRENT_DATE = sh(returnStdout: true, script: 'date +%Y%m%d%H%M').trim()
        GIT_HOST = "https://github.com/taehui8260/web-auto-deploy.git"
    }

    stage('Checkout') {
        git branch: 'main', credentialsId: 'GITHUB_ACCESS_TOKEN', url: "${GIT_HOST}"
    }

    stage('Build') {
        sh "${MAVEN_HOME}/bin/mvn -f pom.xml clean package -P external pmd:pmd pmd:cpd"
    }

    stage('Analysis') {
        def pmd = scanForIssues tool: [$class: 'Pmd'], pattern: 'target/pmd.xml'
        publishIssues issues:[pmd]
    }

    def pom = readMavenPom file: 'pom.xml'
    def ARTIFACT_ID = pom.artifactId
    def VERSION = pom.version
    def BUILD_FILE_NAME = "${ARTIFACT_ID}-${VERSION}.jar"

    stage('Deploy') {
        sh """
        if [ -d /appdata/web-auto-deploy/ ]; then
          rm -rf /appdata/web-auto-deploy/
        fi
        """
        sh "mkdir -m 777 -p /appdata/web-auto-deploy/"
        sh "mkdir -m 777 -p /appdata/web-auto-deploy/back-end"

        sh "cp ./target/${BUILD_FILE_NAME} /appdata/web-auto-deploy/back-end"
        sh "cp -r ./docker/front-end /appdata/web-auto-deploy"
        sh "cp -r ./docker/nginx-lb /appdata/web-auto-deploy"

        sh "cp ./docker/back-end-was/Dockerfile /appdata/web-auto-deploy/back-end"
        sh "cp ./docker/front-end-was/Dockerfile /appdata/web-auto-deploy/front-end"
    }

    def API_CONTAINER_NAME = 'back-end-was'
    def APP_CONTAINER_NAME = 'front-end-was'
    def WEB_CONTAINER_NAME = 'nginx-lb'

    stage('Docker Build/Push/Run') {
        withCredentials([string(credentialsId: 'WSL_SECRET', variable: 'WSL_SECRET'), string(credentialsId: 'DOCKERUSER_SECRET', variable: 'DOCKERUSER_SECRET'), string(credentialsId: 'DOCKER_REGISTRY', variable: 'DOCKER_REGISTRY')]) {
            def remote = [:]
            remote.name = 'wsl_host'
            remote.host = '192.168.50.2'
            remote.port = 22
            remote.user = 'lth1178'
            remote.password = ${WSL_SECRET}
            remote.allowAnyHosts = true
            sshCommand remote: remote, command: """
            cd /appdata/web-auto-deploy/back-end
            sudo docker build -t ${API_CONTAINER_NAME} .
            cd /appdata/web-auto-deploy/front-end
            sudo docker build -t ${APP_CONTAINER_NAME} .
            cd /appdata/web-auto-deploy/nginx-lb
            sudo docker build -t ${WEB_CONTAINER_NAME} .
            sudo docker login -u taehui8260 -p ${DOCKERUSER_SECRET}
            sudo docker tag ${API_CONTAINER_NAME} {DOCKER_REGISTRY}/${API_CONTAINER_NAME}:${CURRENT_DATE}
            sudo docker tag ${APP_CONTAINER_NAME} {DOCKER_REGISTRY}/{APP_CONTAINER_NAME}:${CURRENT_DATE}
            sudo docker tag ${WEB_CONTAINER_NAME} {DOCKER_REGISTRY}/${WEB_CONTAINER_NAME}:${CURRENT_DATE}
            sudo docker rmi ${DOCKER_REGISTRY}/${API_CONTAINER_NAME}:${CURRENT_DATE}
            sudo docker rmi ${DOCKER_REGISTRY}/${APP_CONTAINER_NAME}:${CURRENT_DATE}
            sudo docker rmi ${DOCKER_REGISTRY}/${WEB_CONTAINER_NAME}:${CURRENT_DATE}

            sudo docker run --rm -d -p 8080:8080 -e TZ=Asia/Seoul --name ${API_CONTAINER_NAME} ${API_CONTAINER_NAME}
            sudo docker run --rm -d -p 4000:4000 -e TZ=Asia/Seoul --name ${APP_CONTAINER_NAME} ${APP_CONTAINER_NAME}
            sudo docker run --rm -d -p 80:80 -p 18443:443 -v /applog/web-auto-deploy/web:/var/log/nginx -e TZ=Asia/Seoul --name ${WEB_CONTAINER_NAME} ${WEB_CONTAINER_NAME}
            """, failOnError: true
        }
    }
}